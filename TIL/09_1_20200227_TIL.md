<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>[20200227_TIL_09]</title>
    </head>
    <body>
        <h1>09. 코드 삽입 공격</h1>
        <ul>
            <li>이 책에서는 SQL 인젝션 공격을 포함해 필터 우회 공격이나 추론 기반 공격, 블라인드 공격과 같은 최신 공격 기술에 대해 상세히 다룰 것이다.</li>
            <div>
                <h2>1. 인터프리터 언어 안에 공격 코드 삽입</h2>
                <ul>
                    <li>인터프리터 언어는 실행하는 시점에서 프로그래밍 언어에 포함된 명령어를 해석하고 실행함.</li>
                    <li>인터프리터 언어: 컴파일러를 거쳐 기계어로 변화되지 않고 바로 실행되는 프로그래밍 언어. ex) 파이썬</li>
                    <li>인터프리터 언어가 실행되는 방법 떄문에 코드 삽입이라는 취약점이 발생</li>
                    <li>인터프리터 언어로 개발된 애플리케이션에서 사용자 데이터를 받아들이면 사용자 데이터와 작성된 명령어가 뒤섞이기 때문에 애플리케이션이 작성된 언어의 문법을 이용하여 인젝션 공격을 할 있다.</li>
                    <li>컴파일 언어로 작성된 애플리케이션에서 사용자 데이터는 기계어로 컴파일 되기 때문에 컴파일 언어의 문법을 건들 수 없다.</li>
                    <li>쉘 스크립트: 셸이나 명령 줄 인터프리터에서 돌아가도록 작성되었거나 한 운영 체제를 위해 쓰인 스크립트이다.</li>
                    <li>스크립트 언어: 응용 소프트웨어를 제어하는 컴퓨터 프로그래밍 언어</li>
                    <li>인젝션 공격 단계</li>
                    <ol>
                        <li>애플리케이션에 정상적이지 않은 입력 값이나 문법을 이용하여 인터프리터가 해석하지 못하고 에러를 발생시키게 유도</li>
                        <li>애플리케이션이 응답하는 결과가 코드 삽입 취약점에 의한 것이라고 판단되는 비정상적인 결과가 나오는지 확인</li>
                        <li>에러 메시지가 나타나면 해당 에러 메시지를 통해 서버상에 어떤 문제가 방생됐는지 확인</li>
                        <li>임의의 코드를 애플리케이션에 삽입했을 때 발생한 에러 메시지가 정말로 취약한 것인지 확인하기 위해 처음 입력했던 값을 여러 번 바꿔서 입력</li>
                        <li>마지막으로 해당 문제점을 공격할 수 있는지 검증할 수 있는 안전한 POC(proof-of-concept)를 작성</li>
                        <li>원하는 목적을 얻기 위해 다생 언어와 컴포넌트의 기능에 공격 코드를 삽입해 해당 취약점을 공격</li>
                        <br>
                    </ol>
                    <li>POC(proof-of-concept): 개명 증명, 기존 시장에 없었던 신기술을 도입하기 전에 이를 검증하기 위해 사용하는 것, 특정 방식이나 아이디어를 실현하여 타당성을 증명하는 것</li>
                </ul>
            </div>
            <div>
                <h2>2. SQL 내에 공격 코드 삽입</h2>
                <ul>
                    <li>사용자가 입력한 값을 처리하는 부분에서 입력 값에 대한 검증이 없으면 SQL을 삽입해 공격할 수 있는 SQL인젝션 취약점이 발생</li>
                    <li>9장에서는 SQL 인젝션 취액점에 대해 기본이 되는 개념을 설면한 후 블라인드 탐지와 공격에 대한 최신 기술들을 설명한다.</li>
                    <div>
                        <h3>2_1. 기본적인 취약점 공격</h3>
                        <ul>
                            <li>SQL 쿼리문에 있는 문자열은 반드시 작은따옴표 안에 포홤되어야 한다.</li>
                            <li>SQL 쿼리문에서 작은따옴표를 이용해 에러를 일으켜 에러 결과물을 볼 수 있고, 이를 통해 쿼리를 수정할 수 있는 임의의 SQL문을 작성하여 애플리케이션에 입력할 수 있게 된다.</li>
                            <li>sql 쿼리문에서 더블 하이픈(--)은 그 뒤에 나오는 문장은 주석으로 처리하라는 의미</li>
                            <li>애플리케이션에 데이터를 입력하면 쿼리문에는 자동으로 작은 따옴표가 씌워져서 만들어지게 된다.</li>
                        </ul>
                    </div>
                    <div>
                        <h3>2_2. 로그인 우회</h3>
                        <ul>
                            <li>로그인 폼은 사용자의 입력값을 받아 DB에 있는 사용자 id, pw와 비교한 후 로그인 성공 여부를 결정한다.</li>
                            <li>로그인이 성공하면 애플리케이션은 사용자에게 권한이 부여된 세션을 생성한다.</li>
                            <li>대부분의 애플리케이션에서는 DB에 있는 가장 처음 계정이 관리자가 새용하는 계정으로 되어있다.</li>
                            <li>사용자 입력값에 ' OR 1=1-- 값을 입력하면 쿼리문에는 '' or 1=1--'로 처리가 되고 --뒤 부분은 주석처리되기 때문에 실제 실행되는 쿼리문은 '' or 1=1이다.</li>
                        </ul>
                    </div>
                    <div>
                        <h3>2_3. SQL 인젝션 취약점 검색</h3>
                        <ul>
                            <li>애플리케이션의 대부분은 입력 값에 작은따옴표와 같은 특수문자를 입력하고 그 결과 에러가 발생하는 것을 통해 SQL인젝션의 문제점을 쉽게 찾을 수있다.</li>
                            <li>애플리케이션이 백엔드 DB와 연동하고 있는 부분이 어디인지를 잘 찾아봐야 하고, 이렇게 데이터베이스와 연동하고 있는 모든 부분에 대해 SQL 인젝션 취약점이 존재하는지 테스트해야 함.</li>
                            <li>거의 대부분의 취약점은 관련된 변수의 이름과 해당 값을 처리하는 부분에서 발생한다.</li>
                            <div>
                                <h4>2_3_1. 문자열 데이터</h4>
                                <ul>
                                    <li>사용자가 입력한 문자열이 SQL 쿼리 안에 들어가면 해당 문자열은 작은 따옴표로 감싸진다.</li>
                                    <li>해킹 단계</li>
                                    <ol>
                                        <li>공격하고자 하는 애플리케이션의 입력값 부분에 작은 따옴표 입력, 에러가 발생하는지 여부와 정상적인 것과는 다른 결과가 나오는지 확인, 상세한 에러 메시지가 나오면 에러 메시지의 의미 파악</li>
                                        <li>에러나 다른 결과가 나오면 작은따옴표 두개를 입력, 데이터베이스는 하나의 작은따옴표를 표시하기 위해 두 개의 작은따옴표를이용하고 이렇게 생성된 두개의 작은따옴표는 문장을 닫는 종격자가 아닌 하나의 작은따옴표로 해석, 입력값이 에러를 발생하거나 비정상적인 결과 값을 보여준다면 애플리케이션은 SQL취약점이 존재한다고 볼 수 있다.</li>
                                        <li>취약점이 존재하는지 확실히 검증하기 위한 문자열을 만들기 위해 SQL 연결어를 사용할 수 있다. 조작된 입력 값을 애플리케이션이 동일한 방법으로 처리한다면 SQL 취약점이 존재한다고 생각할 수 있다.</li>
                                        <li>와일드카드 문자: 컴퓨터에서 특정 명령어로 명령을 내릴 때, 여러 파일을 한꺼번에 지정할 목적으로 사용하는 기호</li>
                                        <br>
                                    </ol>
                                </ul>
                            </div>
                            <div>
                                <h4>2_3_2. 숫자 데이터</h4>
                                <ul>
                                    <li>사용자가 입력한 숫자 데이터가 SQL 쿼리에 포함될 때 애플리케이션은 이렇게 입력된 값을 여전히 작은따옴표를 이용해서 문자열 데이터로 처리한다.</li>
                                    <li>그러나 대부분의 경우 숫자 데이터는 숫자 폼에서 데이터베이스에게 바로 전달되고 작은따옴표 안에 포함되지 않는다.</li>
                                    <li>해킹 단계</li>
                                    <ol>
                                        <li>원래 숫자 값이랑 동일한 값을 만들 수 있는 간단한 산술식을 입력한다. 예를 들어 숫자가 2라면 3-1 등과 같은. 애플리케이션이 동일한 결과를 보여준다면 SQL 인젝션 취약점이 존대한다고 볼 수 있다.</li>
                                        <li>처음 테스트가 성공적이면 SQL에 대한 구체적인 키워드와 문법을 이용해서 취약점에 대한 더 많은 상세한 정보를 얻을 수 있다. 좋은 예는 ASCII값을 반환해주는 ASCII명령어를 사용하는 것, 67-ASCII('A')의 결과값은 2와 같다.</li>
                                        <li>ASCII명령어 안의 작은 따옴표가 필터링 되면 숫자데이터를 문자 데이터로 취급해서 시도</li>
                                        <br>
                                    </ol>
                                    <li>SQL 취약점을 찾을 때 종종 입력값을 인코딩해야하는 경우가 있다.</li>
                                </ul>
                            </div>
                        </ul>
                    </div>
                    <div>
                        <h3>2_4. 인젝션에 이용되는 다양한 구문</h3>
                        <ul>
                            <li>SQL 언어는 크게 4개의 명령어가 있다.</li>
                            <div>
                                <h4>2_4_1. SELECT 문</h4>
                                <ul>
                                    <li>select문은 데이처베이스에서 정보를 추출하는 데 사용되며 주로 사용자가 입력한 정보에 대한 결과를 보여줄 때 사용하는 명령문이다.</li>
                                    <li>로그인 부분과 같이 DB에서 정보를 추출해서 입력값을 비교할 떄도 쓰임</li>
                                    <li>SQL인젝션 공격의 시작은 쿼리 부분의 WHERE 조건문에서 이뤄짐</li>
                                    <li>때로는 SQL 인젝션 취약점은 ORDER BY 구문이나 테이블과 칼럼의 이름에서 발생하기도 한다.</li>
                                    <br>
                                </ul>
                            </div>
                            <div>
                                <h4>2_4_2. INSERT 문</h4>
                                <ul>
                                    <li>INSERT문은 테이블 안에 데이터 한 줄을 생성할 때 사용한다.</li>
                                    <li>일반적으로 로그를 새로 생성하거나, 새로운 사용자를 만들거나, 새로운 주문서를 작성할 떄 사용</li>
                                    <li>사용자명과 비밀번호 필드가 SQL 인젝션에 취약하면 공격자는 테이블 안에 최고 관리자 권한을 가진 계정을 임의로 생성할 수 있다.</li>
                                    <li>애플리케이션에서 사용자에게 결과 값을 보여주지 않는 블라인드 환경일 때 공격자는 INSERT문에 공격 코드를 삽입해서 애플리케이션으로부터 문자 데이터를 추출하는 것이 가능할 수 있다.</li>
                                    <br>
                                </ul>
                            </div>
                            <div>
                                <h4>2_4_3. UPDATE 문</h4>
                                <ul>
                                    <li>UPDATE문은 테이블 내 존재하는 데이터 열에 대해서 한 개나 그 이상의 데이터를 수정할 때 사용한다.</li>
                                    <li>이 명령어는 이미 존재하고 있는 데이터 값을 변결하는 기능이 있는 부분에서 가끔 사용</li>
                                    <li>원격 애플리케이션에서 SQL 인젝션 취약점을 찾는 것은 공격자가 입력한 값이 애플리케이션에서 잠재적으로 어떻게 처리되는지 정확하게 아는 방법이 없기 때문데 항상 위험성이 따른다.</li>
                                    <br>
                                </ul>
                            </div>
                            <div>
                                <h4>2_4_4. DELETE 문</h4>
                                <ul>
                                    <li>DELETE 문은 테이블 내 존재하는 테이터 열에 대해서 한개나 그 이상이 데이터를 삭제할 떄 사용하는 명령어다.</li>
                                    <li>사용자가 입력한 SQL 인젝션 공격은 WHERE 조건문 부분을 변경하고 파괴해 버리기 때문에 공격의 영향은 UPDATE 문에서 SQL인젝션 공격을 하는 것과 동일한 효과를 발휘</li>
                                </ul>
                            </div>
                        </ul>
                    </div>
                    <div>
                        <h3>2_5. UNION 연산자</h3>
                        <ul>
                            <li>UNION 연산자는 두 개나 그 이상의 SELECT문을 하나의 결과로 합칠 때 사용</li>
                            <li>애플리케이션에 SELECT문에 취약점이 존재할 경우 UNION문을 사용해서 두 번째 SELECT 문을 실행 할 수 있다.</li>
                            <li>UNION 연산자를 이용해서 공격하기 전에 두 개의 중요한 요소를 고려해야 한다.</li>
                            <ol>
                                <li>UNION 연산자를 이용해서 두 개의 조합된 쿼리의 결과가 반환될 때 두 개의 결과는 동일 한 구조여야 함. 즉 두 select문이 동일한 개수의 칼럼을 가져야 함.</li>
                                <li>두 번째 삽입한 쿼리문이 우용한 결과를 얻기 위해서는, 공격자는 데이터베이스에서 내용을 보고자 하는 테이블명과 해당 테이블에 있는 칼럼명을 정확하게 알아야 한다.</li>
                                <br>
                            </ol>
                            <li>대부분의 실제 공격 상황에서 데이터베이스의 에러 메시지는 애플리케이션 내에서 처리되고 사용자의 브라우저 화면으로는 잘 보여주지 않을 것이다. 그렇기 떄문에 테이터베이스의 구조를 파악하는 것은 순수하게 추측 공격으로는 한계가 따른다.</li>
                            <li>공격 작업을 좀 더 쉽게 할 수 있는 세 가지 중요한 부분</li>
                            <ol>
                                <li>첫 번째 SELECT문과 연결되는 두 버넂 SELECT문을 삽입할 때 첫 번째 쿼리문에 있는 데이터 타입과 완벽하게 똑같을 필요는 없다.</li>
                            </ol>
                        </ul>
                    </div>
                </ul>
            </div>
        </ul>
        <br>
        <br>
        <div>
            <h2>Questions</h2>
            <ul>
                <li>cmd도 셸 스크립트 언어의 일종인가?</li>
                <li>더블 하이픈이 주석 기능을 하려면 작은 따옴표안에 포함되면 안되는가?</li>
                <li>어떤 에러가 떠야지 취약점이 있는 것인가? 그냥 에러가 나오기만 하면 취약점이 있는 것인가? 아니면 에러를 보고 어디에 문제가 있는지 알아내는 것인가?</li>
                <li>숫자 PageID 변수가 무엇인가?</li>
                <li>블라인드 SQL 인젝션은 에러값이 반환되지 않는 환경에서의 SQL 인젝션 공격인가?</li>
            </ul>
        </div>
    </body>
</html>
